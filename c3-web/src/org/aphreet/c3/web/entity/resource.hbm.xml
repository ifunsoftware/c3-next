<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC
	"-//Hibernate/Hibernate Mapping DTD 3.0//EN"
	"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping package="org.aphreet.c3.entity">
	<class name="Resource" table="resources" abstract="true">
		<id name="id" type="int">
			<generator class="native"/>
		</id>
		<property name="title" type="text" not-null="true" index="resource_title"/>
		<property name="createDate" not-null="true"/>
		
		<component name="metadata" class="Metadata">
			<set name="tags" table="resource_tag">
				<key column="resource_id"/>
				<many-to-many class="MetadataTag" column="tag_id"/>
			</set>
			
			<map name="values" table="resource_metadata">
				<key column="resource_id"/>
				<map-key-many-to-many class="MetadataKey" column="key_id"/>
				<element column="value" type="string" not-null="true" />
			</map> 
		</component>
		
		<many-to-one name="owner" class="User" column="user_id" not-null="true"/>
		<many-to-one name="group" class="AbstractGroup" column="group_id" not-null="true" lazy="false"/>
		
		<joined-subclass name="INode" table="inodes">
			<key column="id" />
			<property name="name" not-null="true"/>
			<many-to-one name="parent" class="INode" column="parent_id"/>
			<set name="children" cascade="all-delete-orphan" lazy="false" order-by="name">
				<key column="parent_id"/>
				<one-to-many class="INode"/>
			</set>
			
			<joined-subclass name="Document" table="document">
				<key column="id"/>
				<property name="contentAddress" not-null="true" unique="true" column="content_address"/>
				<property name="contentType" not-null="true" column="content_type"/>
				<property name="extension" />
				<list name="versions" cascade="all-delete-orphan">
					<key column="document_id"/>
					<list-index column="number" base="1"/>
					<one-to-many class="DocumentVersion"/>
				</list>
			</joined-subclass>
			
		</joined-subclass>
		
		<joined-subclass name="Message" table="messages">
			<key column="id"/>
			<property name="body" type="text"/>
			<set name="children" cascade="all-delete-orphan" lazy="false" order-by="id">
				<key column="parent_id"/>
				<one-to-many class="Message"/>
			</set>
			<many-to-one name="parent" class="Message" column="parent_id"/>
		</joined-subclass>
		
		<joined-subclass name="Reference" table="reference">
			<key column="id"/>
			<property name="uri" not-null="true"/>
			<property name="comment" type="text"/>
		</joined-subclass>
		
		<joined-subclass name="WikiPage" table="wiki_page">
			<key column="id"/>
			<list name="versions" cascade="all-delete-orphan">
				<key column="page_id"/>
				<list-index column="number" base="1"/>
				<one-to-many class="WikiPageVersion"/>
			</list>
		</joined-subclass>
	</class>
	
	<class name="MetadataKey" table="metadata_key">
		<id name="id">
			<generator class="native"/>
		</id>
		<property name="name" not-null="true" unique="true"/>
	</class>
	
	<class name="MetadataTag" table="metadata_tag">
		<id name="id">
			<generator class="native"/>
		</id>
		<property name="name" not-null="true" unique="true"/>
	</class>
	
	<class name="WikiPageVersion" table="wiki_page_version">
		<id name="id" column="id">
			<generator class="native"/>
		</id>
		<property name="editDate" column="edit_date"/>
		<property name="body" type="text"/>
		<property name="htmlBody" type="text" column="html_body"/>
		<many-to-one name="editor" class="User" column="editor_id"/>
		<many-to-one name="page" column="page_id" class="WikiPage"/>
	</class>
	
	<class name="DocumentVersion" table="document_version">
		<id name="id" column="id">
			<generator class="native"/>
		</id>
		<property name="storageRevision" not-null="true" column="storage_revision"/>
		<property name="size"/>
		<property name="editDate" column="edit_date"/>
		<many-to-one name="editor" class="User" column="editor_id"/>
		<many-to-one name="document" class="Document" column="document_id"/>
	</class>
	
	<query name="res_inode_root">from org.aphreet.c3.entity.INode node 
		where 
			node.parent is null 
			and 
			node.group.id = :groupId
	</query>
	<query name="res_document_by_path">
		from org.aphreet.c3.entity.Document doc where doc.contentAddress = :path
	</query>
</hibernate-mapping>